#!/usr/bin/perl
#
#
print "\n";
print "--| alya-time-set |-- \n";
print "\n";
print "--| Postprocess set file by extracting the temporal series\n";
print "--| The output file is \"alya-sets.out\" \n";
print "\n";

$fils = $ARGV[0];

if ((@ARGV < 5) || ($ARGV[0] =~ /-h/)) { 
  print "    Usage:   alya-time-set \"file-name.***.set\" [set-number , column , t_ini , t_fin] \n\n";
  exit 1;
}

$setnum    =  @ARGV[1];
$colnum    =  @ARGV[2];
$tini      =  @ARGV[3];
$tfin      =  @ARGV[4];

$outfils   = ">alya-time-set.out";

open (IN, $fils);
print "--|   First pass: counting lines... \n";
$kread= -1;
$nline=  0;
$tiref= -1;
while (<IN>) {
    if ($kread == -1) {
	if ($_ =~ /Time/i) {
	    @cosas = split;
	    $ncosas = @cosas;
	    $timste = @cosas[$ncosas-1];
	    $kread=10;
	    $i=0;
	    $iyes=0;
	    if ($timste >= $tini) {
		if ($timste <= $tfin) {
		    $iyes=1;
		    if ($tiref < 0) {$tiref=$timste}
		}
	    }
	}
    }
    elsif ($kread == 10) {
	$i++;
	if ($i==$setnum) {
	    $kread = -1;	    
	    if ($iyes==1) {$nline++}
	}
    }
}

close(IN);

print "--|   Second pass: writing... \n";

open (OUT,$outfils);
print OUT "\# \n";
print OUT "\# Temporal set automatically generated by alya-time-set \n";
print OUT "\# \n";
print OUT "\# 1. Time        2. Variable \n";
print OUT "\# Following number of lines = $nline \n";


open (IN, $fils);
$kread=-1;
$tiaux=0;
while (<IN>) {
    if ($kread == -1) {
	if ($_ =~ /Time/i) {
	    @cosas  = split;
	    $ncosas = @cosas;
	    $timste = @cosas[$ncosas-1];
	    $iyes=0;
	    if ($timste >= $tini) {if ($timste <= $tfin) {$iyes=1}}
	    $kread=10;
	    $i=0;
	}
    }
    elsif ($kread == 10) {
	$i++;	
	if ($i==$setnum) {
	    if ($iyes==1) {
		@cosas  = split;
		$valset = @cosas [$colnum-1];
		$timste = $timste - $tiref;
		$tidif  = $timste - $tiaux;
		if ($timste == 0) {$timste=$timste . "\.0000"}
		if ($tidif  == 0) {$tidif =$tidif  . "\.0000"}
		print OUT "  $timste   $valset   $tidif   \n";	    
		$tiaux  = $timste;
	    }
	    $kread = -1;	    
	}
    }
}

print "--| bye! \n\n";

